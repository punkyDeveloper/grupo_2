import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import warnings
import os
warnings.filterwarnings('ignore')

# Configuraci√≥n de estilo para las gr√°ficas
plt.style.use('seaborn-v0_8')
sns.set_palette("husl")
plt.rcParams['figure.figsize'] = (15, 10)
plt.rcParams['font.size'] = 10

print("=== AN√ÅLISIS DE DESERCI√ìN UNIVERSITARIA EN COLOMBIA ===")
print("üìä USANDO PANDAS PARA LEER EL ARCHIVO EXCEL REAL")
print("üóìÔ∏è Periodo: 2010-2022 | Nivel: UNIVERSITARIO")
print("=" * 70)

# ===== LEER EL ARCHIVO EXCEL CON PANDAS =====
archivo_excel = os.path.join(os.path.dirname(__file__),"..", "datos", "1.ESTAD√çSTICASDEDESERCI√ìNYPERMANENCIAENEDUCACI√ìNSUPERIOR.xlsx")

try:
    print(f"\nüìÇ Leyendo archivo: {archivo_excel}")
    
    # 1. LEER DATOS POR SEXO
    print("\nüìä 1. EXTRAYENDO DATOS POR SEXO...")
    df_sexo_raw = pd.read_excel(archivo_excel, sheet_name='TD - sexo', header=None)
    
    # Encontrar la fila con los a√±os y los datos
    # Seg√∫n el an√°lisis anterior: fila 12 = a√±os, fila 13 = hombres, fila 14 = mujeres
    a√±os = df_sexo_raw.iloc[12, 1:14].tolist()  # Columnas 1-13 (a√±os 2010-2022)
    hombres_raw = df_sexo_raw.iloc[13, 1:14].tolist()  # Datos hombres
    mujeres_raw = df_sexo_raw.iloc[14, 1:14].tolist()  # Datos mujeres
    
    print(f"‚úÖ A√±os extra√≠dos: {len(a√±os)} valores")
    print(f"‚úÖ Datos hombres: {len(hombres_raw)} valores")
    print(f"‚úÖ Datos mujeres: {len(mujeres_raw)} valores")
    
    # Crear DataFrame limpio por sexo
    datos_sexo = []
    for i, a√±o in enumerate(a√±os):
        if pd.notna(a√±o) and pd.notna(hombres_raw[i]) and pd.notna(mujeres_raw[i]):
            datos_sexo.append({
                'a√±o': int(a√±o), 'sexo': 'Hombre', 
                'tasa_desercion': hombres_raw[i],
                'porcentaje': round(hombres_raw[i] * 100, 2),
                'nivel_formacion': 'Universitario'
            })
            datos_sexo.append({
                'a√±o': int(a√±o), 'sexo': 'Mujer', 
                'tasa_desercion': mujeres_raw[i],
                'porcentaje': round(mujeres_raw[i] * 100, 2),
                'nivel_formacion': 'Universitario'
            })
    
    df_sexo = pd.DataFrame(datos_sexo)
    print(f"‚úÖ Dataset por sexo creado: {len(df_sexo)} registros")
    print("Muestra de datos por sexo:")
    print(df_sexo.head())
    
    # 2. LEER DATOS POR METODOLOG√çA
    print("\nüìä 2. EXTRAYENDO DATOS POR METODOLOG√çA...")
    df_metodologia_raw = pd.read_excel(archivo_excel, sheet_name='TD - metodolog√≠a', header=None)
    
    # Seg√∫n an√°lisis: fila 13 = a√±os, filas 14-17 = metodolog√≠as
    a√±os_metodo = df_metodologia_raw.iloc[13, 1:14].tolist()
    presencial_raw = df_metodologia_raw.iloc[14, 1:14].tolist()
    dist_tradicional_raw = df_metodologia_raw.iloc[15, 1:14].tolist()
    dist_virtual_raw = df_metodologia_raw.iloc[16, 1:14].tolist()
    dual_raw = df_metodologia_raw.iloc[17, 1:14].tolist()
    
    print(f"‚úÖ A√±os metodolog√≠a: {len(a√±os_metodo)} valores")
    
    # Crear DataFrame limpio por metodolog√≠a
    datos_metodologia = []
    metodologias_datos = {
        'Presencial': presencial_raw,
        'Distancia tradicional': dist_tradicional_raw,
        'Distancia virtual': dist_virtual_raw,
        'Dual': dual_raw
    }
    
    for metodologia, datos_raw in metodologias_datos.items():
        for i, a√±o in enumerate(a√±os_metodo):
            if pd.notna(a√±o) and pd.notna(datos_raw[i]):
                datos_metodologia.append({
                    'a√±o': int(a√±o), 'metodologia': metodologia,
                    'tasa_desercion': datos_raw[i],
                    'porcentaje': round(datos_raw[i] * 100, 2),
                    'nivel_formacion': 'Universitario'
                })
    
    df_metodologia = pd.DataFrame(datos_metodologia)
    print(f"‚úÖ Dataset por metodolog√≠a creado: {len(df_metodologia)} registros")
    print("Muestra de datos por metodolog√≠a:")
    print(df_metodologia.head())
    
    # 3. LEER DATOS POR √ÅREA DE CONOCIMIENTO
    print("\nüìä 3. EXTRAYENDO DATOS POR √ÅREA DE CONOCIMIENTO...")
    df_area_raw = pd.read_excel(archivo_excel, sheet_name='TD - √°rea de conocimiento', header=None)
    
    # Seg√∫n an√°lisis: fila 12 = a√±os, filas 13-20 = √°reas de conocimiento
    a√±os_area = df_area_raw.iloc[12, 1:14].tolist()
    
    areas_conocimiento = [
        'Agronom√≠a veterinaria y afines',
        'Bellas artes',
        'Ciencias de la educaci√≥n',
        'Ciencias de la salud', 
        'Ciencias sociales y humanas',
        'Econom√≠a, administraci√≥n, contadur√≠a y afines',
        'Ingenier√≠a, arquitectura, urbanismo y afines',
        'Matem√°ticas y ciencias naturales'
    ]
    
    print(f"‚úÖ A√±os √°rea: {len(a√±os_area)} valores")
    print(f"‚úÖ √Åreas de conocimiento: {len(areas_conocimiento)} √°reas")
    
    # Extraer datos por √°rea
    datos_area = []
    for i, area in enumerate(areas_conocimiento):
        fila_index = 13 + i  # Filas 13-20
        area_datos_raw = df_area_raw.iloc[fila_index, 1:14].tolist()
        
        for j, a√±o in enumerate(a√±os_area):
            if pd.notna(a√±o) and pd.notna(area_datos_raw[j]):
                datos_area.append({
                    'a√±o': int(a√±o), 'area_conocimiento': area,
                    'tasa_desercion': area_datos_raw[j],
                    'porcentaje': round(area_datos_raw[j] * 100, 2),
                    'nivel_formacion': 'Universitario'
                })
    
    df_area = pd.DataFrame(datos_area)
    print(f"‚úÖ Dataset por √°rea creado: {len(df_area)} registros")
    print("Muestra de datos por √°rea:")
    print(df_area.head())
    
    # 4. AN√ÅLISIS: CARRERAS QUE M√ÅS DESERTAN
    print("\nüî• 4. AN√ÅLISIS: CARRERAS QUE M√ÅS DESERTAN...")
    areas_promedio = df_area.groupby('area_conocimiento')['porcentaje'].mean().sort_values(ascending=False)
    
    print("\nüéØ RANKING REAL - Carreras ordenadas por mayor deserci√≥n:")
    for i, (area, tasa) in enumerate(areas_promedio.items(), 1):
        print(f"{i}. {area}: {tasa:.2f}%")
    
    # 5. CREAR DATASET CONSOLIDADO
    print("\nüìã 5. CREANDO DATASET CONSOLIDADO...")
    
    df_sexo['tipo_analisis'] = 'sexo'
    df_metodologia['tipo_analisis'] = 'metodologia'
    df_area['tipo_analisis'] = 'area_conocimiento'
    
    df_sexo['categoria'] = df_sexo['sexo']
    df_metodologia['categoria'] = df_metodologia['metodologia']
    df_area['categoria'] = df_area['area_conocimiento']
    
    columnas_comunes = ['a√±o', 'categoria', 'tasa_desercion', 'porcentaje', 'nivel_formacion', 'tipo_analisis']
    
    df_consolidado = pd.concat([
        df_sexo[columnas_comunes],
        df_metodologia[columnas_comunes],
        df_area[columnas_comunes]
    ], ignore_index=True)
    
    print(f"‚úÖ Dataset consolidado creado: {len(df_consolidado)} registros")
    
    # 6. VISUALIZACIONES
    print("\nüìà 6. GENERANDO VISUALIZACIONES...")
    
    fig = plt.figure(figsize=(20, 16))
    
    # Gr√°fica 1: Evoluci√≥n por sexo
    plt.subplot(2, 3, 1)
    df_sexo_pivot = df_sexo.pivot(index='a√±o', columns='sexo', values='porcentaje')
    plt.plot(df_sexo_pivot.index, df_sexo_pivot['Hombre'], marker='o', linewidth=3, 
             label='Hombres', color='#1f77b4', markersize=6)
    plt.plot(df_sexo_pivot.index, df_sexo_pivot['Mujer'], marker='s', linewidth=3, 
             label='Mujeres', color='#ff7f0e', markersize=6)
    plt.title('Evoluci√≥n de Deserci√≥n por Sexo\n(Datos del archivo Excel)', 
              fontsize=14, fontweight='bold')
    plt.xlabel('A√±o')
    plt.ylabel('Tasa de Deserci√≥n (%)')
    plt.legend()
    plt.grid(True, alpha=0.3)
    
    # Gr√°fica 2: Comparaci√≥n por metodolog√≠a
    plt.subplot(2, 3, 2)
    metodologia_promedio = df_metodologia.groupby('metodologia')['porcentaje'].mean().sort_values(ascending=False)
    colors = ['#d62728', '#ff7f0e', '#2ca02c', '#1f77b4']
    bars = plt.bar(range(len(metodologia_promedio)), metodologia_promedio.values, color=colors)
    plt.title('Promedio por Metodolog√≠a\n(Datos del archivo)', fontsize=14, fontweight='bold')
    plt.xlabel('Metodolog√≠a')
    plt.ylabel('Tasa de Deserci√≥n (%)')
    plt.xticks(range(len(metodologia_promedio)), 
               [m.replace(' ', '\n') for m in metodologia_promedio.index], rotation=0)
    plt.grid(True, alpha=0.3, axis='y')
    
    for i, bar in enumerate(bars):
        height = bar.get_height()
        plt.text(bar.get_x() + bar.get_width()/2., height + 0.3,
                 f'{height:.1f}%', ha='center', va='bottom', fontweight='bold')
    
    # Gr√°fica 3: Top 5 √°reas con mayor deserci√≥n
    plt.subplot(2, 3, 3)
    top_areas = areas_promedio.head(5)
    bars = plt.barh(range(len(top_areas)), top_areas.values, color='#d62728', alpha=0.7)
    plt.title('Top 5 Carreras con Mayor Deserci√≥n\n(Del archivo Excel)', fontsize=14, fontweight='bold')
    plt.xlabel('Tasa de Deserci√≥n Promedio (%)')
    plt.yticks(range(len(top_areas)), 
               [area.replace(',', '\n') for area in top_areas.index])
    plt.grid(True, alpha=0.3, axis='x')
    
    for i, bar in enumerate(bars):
        width = bar.get_width()
        plt.text(width + 0.1, bar.get_y() + bar.get_height()/2.,
                 f'{width:.1f}%', ha='left', va='center', fontweight='bold')
    
    # Gr√°fica 4: Evoluci√≥n temporal por metodolog√≠a
    plt.subplot(2, 3, 4)
    metodologias_principales = ['Presencial', 'Distancia virtual', 'Distancia tradicional']
    for metodologia in metodologias_principales:
        data_metodo = df_metodologia[df_metodologia['metodologia'] == metodologia]
        if not data_metodo.empty:
            plt.plot(data_metodo['a√±o'], data_metodo['porcentaje'], marker='o', 
                     linewidth=2, label=metodologia)
    
    plt.title('Evoluci√≥n por Metodolog√≠a\n(Del archivo)', fontsize=14, fontweight='bold')
    plt.xlabel('A√±o')
    plt.ylabel('Tasa de Deserci√≥n (%)')
    plt.legend()
    plt.grid(True, alpha=0.3)
    
    # Gr√°fica 5: Boxplot por sexo
    plt.subplot(2, 3, 5)
    sns.boxplot(data=df_sexo, x='sexo', y='porcentaje', palette=['#1f77b4', '#ff7f0e'])
    plt.title('Distribuci√≥n de Deserci√≥n por Sexo\n(Todos los a√±os)', fontsize=14, fontweight='bold')
    plt.xlabel('Sexo')
    plt.ylabel('Tasa de Deserci√≥n (%)')
    
    # Gr√°fica 6: Heatmap de las 5 √°reas m√°s cr√≠ticas
    plt.subplot(2, 3, 6)
    top5_areas = areas_promedio.head(5).index
    df_area_top5 = df_area[df_area['area_conocimiento'].isin(top5_areas)]
    
    if not df_area_top5.empty:
        pivot_top5 = df_area_top5.pivot(index='area_conocimiento', columns='a√±o', values='porcentaje')
        pivot_top5 = pivot_top5.reindex(top5_areas)
        pivot_top5.index = [area.split(',')[0] for area in pivot_top5.index]
        
        sns.heatmap(pivot_top5, annot=True, fmt='.1f', cmap='Reds', 
                    cbar_kws={'label': 'Tasa (%)'})
        plt.title('Heatmap: Top 5 √Åreas Cr√≠ticas\n(Por A√±o)', fontsize=14, fontweight='bold')
        plt.xlabel('A√±o')
        plt.ylabel('√Årea de Conocimiento')
    
    plt.tight_layout()
    plt.show()
    
    # 7. ESTAD√çSTICAS DESCRIPTIVAS
    print("\nüìä 7. ESTAD√çSTICAS DESCRIPTIVAS (DEL ARCHIVO)")
    print("="*60)
    
    print("\nüî∏ RESUMEN POR SEXO:")
    resumen_sexo = df_sexo.groupby('sexo')['porcentaje'].agg(['count', 'mean', 'std', 'min', 'max']).round(2)
    print(resumen_sexo)
    
    if len(resumen_sexo) >= 2:
        brecha_genero = resumen_sexo.loc['Hombre', 'mean'] - resumen_sexo.loc['Mujer', 'mean']
        print(f"\nüë• BRECHA DE G√âNERO: {brecha_genero:.2f} puntos porcentuales")
    
    print("\nüî∏ RESUMEN POR METODOLOG√çA:")
    resumen_metodologia = df_metodologia.groupby('metodologia')['porcentaje'].agg(['count', 'mean', 'std', 'min', 'max']).round(2)
    resumen_metodologia = resumen_metodologia.sort_values('mean', ascending=False)
    print(resumen_metodologia)
    
    print("\nüî∏ RESUMEN POR √ÅREA DE CONOCIMIENTO:")
    resumen_areas = df_area.groupby('area_conocimiento')['porcentaje'].agg(['count', 'mean', 'std', 'min', 'max']).round(2)
    resumen_areas = resumen_areas.sort_values('mean', ascending=False)
    print(resumen_areas)
    
    # 8. EXPORTAR DATOS LIMPIOS A CSV
    print("\nüíæ 8. EXPORTANDO DATASETS A CSV...")
    
    df_sexo.to_csv('desercion_por_sexo_PANDAS.csv', index=False, encoding='utf-8')
    df_metodologia.to_csv('desercion_por_metodologia_PANDAS.csv', index=False, encoding='utf-8')
    df_area.to_csv('desercion_por_area_conocimiento_PANDAS.csv', index=False, encoding='utf-8')
    df_consolidado.to_csv('desercion_consolidado_PANDAS.csv', index=False, encoding='utf-8')
    
    print("‚úÖ Archivos CSV exportados con pandas:")
    print("   üìÑ desercion_por_sexo_PANDAS.csv")
    print("   üìÑ desercion_por_metodologia_PANDAS.csv") 
    print("   üìÑ desercion_por_area_conocimiento_PANDAS.csv")
    print("   üìÑ desercion_consolidado_PANDAS.csv")
    
    # 9. INSIGHTS PRINCIPALES
    print("\nüéØ 9. INSIGHTS PRINCIPALES (EXTRA√çDOS CON PANDAS)")
    print("="*60)
    
    if not areas_promedio.empty:
        area_mas_critica = areas_promedio.index[0]
        area_mas_estable = areas_promedio.index[-1]
        print(f"üî• CARRERA QUE M√ÅS DESERTA: {area_mas_critica} ({areas_promedio.iloc[0]:.2f}%)")
        print(f"‚úÖ CARRERA M√ÅS ESTABLE: {area_mas_estable} ({areas_promedio.iloc[-1]:.2f}%)")
    
    if not resumen_metodologia.empty:
        metodologia_critica = resumen_metodologia.index[0]
        metodologia_estable = resumen_metodologia.index[-1]
        print(f"‚ö†Ô∏è  METODOLOG√çA M√ÅS CR√çTICA: {metodologia_critica} ({resumen_metodologia.iloc[0]['mean']:.1f}%)")
        print(f"‚úÖ METODOLOG√çA M√ÅS ESTABLE: {metodologia_estable} ({resumen_metodologia.iloc[-1]['mean']:.1f}%)")
    
    if len(resumen_sexo) >= 2:
        print(f"üë• BRECHA DE G√âNERO: Hombres desertan {brecha_genero:.2f}% m√°s que mujeres")
    
    print(f"\nüèÜ TOP 3 CARRERAS M√ÅS CR√çTICAS:")
    for i, (area, tasa) in enumerate(areas_promedio.head(3).items(), 1):
        print(f"   {i}. {area}: {tasa:.2f}%")
    
    print("\n" + "="*60)
    print("‚ú® AN√ÅLISIS COMPLETADO USANDO PANDAS PARA LEER EL ARCHIVO ‚ú®")
    print("üìä Todos los datos fueron extra√≠dos directamente del Excel")
    print("="*60)

except FileNotFoundError:
    print(f"‚ùå Error: No se pudo encontrar el archivo '{archivo_excel}'")
    print("üìù Aseg√∫rate de que el archivo est√© en el mismo directorio que este script")
    
except Exception as e:
    print(f"‚ùå Error al procesar el archivo: {str(e)}")
    print("üìù Verifica que el archivo Excel no est√© corrupto y tenga las hojas esperadas")